{{- range $projectName, $projectSettings := .Values.projects }}
{{- range $projectSettings.applications }}
{{- $appName := .name -}}
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ $appName }}
  namespace: argocd
  labels:
    {{- toYaml (merge (default (dict) .labels) (index $.Values.projects $projectName).labels) | nindent 4}}
spec:
  project: '{{ $projectName }}'
  syncPolicy:
    {{- if .autoSync.enabled }}
    automated:
      selfHeal: {{ .autoSync.selfHeal }}
      prune: {{ .autoSync.prune }}
    {{- end }}
    managedNamespaceMetadata:
      labels:
        project: {{ $projectName }}
    syncOptions:
    - CreateNamespace=true
    retry:
      limit: 6
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m0s
  sources:
    - repoURL: "{{ $.Values.repoURL }}"
      targetRevision: "{{ $.Values.targetRevision }}"
      ref: values
    - repoURL: "{{ $.Values.repoURL }}"
      targetRevision: "{{ $.Values.targetRevision }}"
      path: {{ $.Values.projectsRoot }}/applications/{{ $projectName }}/{{ $appName }}
      helm:
        valueFiles:
          - $values/{{ $.Values.projectsRoot }}/applications/{{ $projectName }}/{{ $appName }}/values.yaml
        {{- range .extraValuesFiles }}
          - $values/{{ $.Values.projectsRoot }}/applications/{{ $projectName }}/{{ $appName }}/{{ . }}
        {{- end }}
  destination:
    server: https://kubernetes.default.svc
    namespace: {{ .namespace }}
  {{- with .ignoreDifferences }}
  ignoreDifferences:
    {{- toYaml . | nindent 4 }}
  {{- end }}
---
{{- end }}
{{- end }}
